import logging
import os

from config import OPERATOR_ID, DIR_FOR_SAVE_DIALOGS
from handlers.keyboards import keyboard_for_menu_in_dialogue, keyboard_for_view_customer_information
from services.db_data import get_user_data_from_db
from services.redis_db import redis_cache
from services.states import MyStates
from services.string_parser import CallDataParser

logger = logging.getLogger(__name__)


def dialogue_logging(client_id):
    log_dialogue_in_file = logging.getLogger(f'logger_for_dialogue_{client_id}')
    if not log_dialogue_in_file.handlers:
        log_dir = f'{DIR_FOR_SAVE_DIALOGS}/{client_id}'
        if not os.path.exists(log_dir):
            os.makedirs(log_dir)
        file_handler = logging.FileHandler(f'{DIR_FOR_SAVE_DIALOGS}/{client_id}/dialogue.log')
        formatter = logging.Formatter('%(asctime)s - %(message)s', datefmt='%Y-%m-%d %H:%M:%S')
        file_handler.setFormatter(formatter)
        log_dialogue_in_file.addHandler(file_handler)
        log_dialogue_in_file.setLevel(logging.INFO)
        log_dialogue_in_file.propagate = False
    return log_dialogue_in_file


def callback_instant_messaging_service(call, bot):
    client_id = call.from_user.id
    operator_state = redis_cache.get_operator_state()
    logger.info(f'–ó–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ {client_id} –Ω–∞ –¥–∏–∞–ª–æ–≥')
    match operator_state:
        case b'free' | None:
            redis_cache.set_operator_state(b'busy')
            logger.info(f'–ü–µ—Ä–µ–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ "–∑–∞–Ω—è—Ç" (busy)')
            bot.send_message(OPERATOR_ID, f'üí¨–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–∏–∞–ª–æ–≥!üß®\n\n–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\nID: {call.from_user.id}\n'
                                          f'–ò–º—è: {call.from_user.first_name}',
                             reply_markup=keyboard_for_view_customer_information(client_id))
        case _:
            logger.info(f'–û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–Ω—è—Ç')
    match redis_cache.add_client_to_queue(client_id):
        case True:
            logger.info(f'–ö–ª–∏–µ–Ω—Ç {client_id} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –æ—á–µ—Ä–µ–¥–∏ –∏ –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞')
            bot.send_message(call.message.chat.id, '–ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä –∫ –≤–∞–º –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è...')
        case _:
            logger.info(f'–ö–ª–∏–µ–Ω—Ç {client_id} —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—á–µ—Ä–µ–¥–∏')
            bot.send_message(call.message.chat.id,
                             '–í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Äüë® –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º ‚Äçüíªüòä')
            bot.send_message(OPERATOR_ID,
                             '–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ –∫–ª–∏–µ–Ω—Ç–µ) –û–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º')


def callback_enter_into_a_dialog(call, bot):
    operator = call.from_user.id
    client_id = CallDataParser.get_client_id(call.data)
    redis_cache.move_client_to_first_place_in_queue(client_id)
    redis_cache.set_operator_state(b'busy')
    logger.info(f'–û–ø–µ—Ä–∞—Ç–æ—Ä –≤—Å—Ç—É–ø–∏–ª –≤ –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º {client_id}')
    bot.set_state(client_id, MyStates.dialogue_with_operator)
    bot.set_state(operator, MyStates.dialogue_with_client)
    bot.delete_message(call.message.chat.id, call.message.id)
    bot.send_message(client_id, '–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –¥–∏–∞–ª–æ–≥ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º\n')
    bot.send_message(operator, '–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º\n–ù–∞–ø–∏—à–∏—Ç–µ –µ–º—É:',
                     reply_markup=keyboard_for_menu_in_dialogue())
    logger.info(
        f'–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ - {bot.get_state(client_id)}, –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - {bot.get_state(operator)}')


def callback_client_info(call, bot):
    operator = call.from_user.id
    client_id = CallDataParser.get_client_id(call.data)
    bot.send_message(operator, '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
                     reply_markup=keyboard_for_view_customer_information(client_id))


def send_request_to_operator(message, bot):
    bot.send_message(message.from_user.id, f'–ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä –∫ –≤–∞–º –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è...')


def send_message_to_client(message, bot):
    client_id = redis_cache.get_first_client_from_queue()
    log_dialogue = dialogue_logging(client_id)
    bot.send_message(client_id, f'üí¨–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:\n\n{message.text}')
    log_dialogue.info(f'–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: {message.text}')


def send_document_to_client(message, bot):
    client_id = redis_cache.get_first_client_from_queue()
    log_dialogue = dialogue_logging(client_id)
    bot.send_document(client_id, document=message.document.file_id)
    log_dialogue.info('–û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª')


def send_photo_to_client(message, bot):
    client_id = redis_cache.get_first_client_from_queue()
    log_dialogue = dialogue_logging(client_id)
    photo_id = message.photo[-1].file_id
    bot.send_photo(client_id, photo=photo_id)
    log_dialogue.info('–û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ä—Ç–∏–Ω–∫—É')


def send_message_to_operator(message, bot):
    client_id = message.from_user.id
    user_data = get_user_data_from_db(client_id)
    log_dialogue = dialogue_logging(client_id)
    log_dialogue.info(f'{user_data["company"]}|–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ {user_data["name"]}: {message.text}')
    bot.send_message(OPERATOR_ID, f'–í—ã –æ–±—â–∞–µ—Ç–µ—Å—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º: {user_data["name"]}\n'
                                  f'–ö–æ–º–ø–∞–Ω–∏—è: {user_data["company"]}\n'
                                  f'–¢–µ–ª–µ—Ñ–æ–Ω: {user_data["phone"]}\n\n'
                                  f'–°–æ–æ–±—â–µ–Ω–∏–µ:\n{message.text}',
                     reply_markup=keyboard_for_menu_in_dialogue())


def send_document_to_operator(message, bot):
    client_id = message.from_user.id
    log_dialogue = dialogue_logging(client_id)
    bot.send_document(OPERATOR_ID, document=message.document.file_id)
    log_dialogue.info('–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª')


def send_photo_to_operator(message, bot):
    client_id = message.from_user.id
    log_dialogue = dialogue_logging(client_id)
    photo_id = message.photo[-1].file_id
    bot.send_photo(OPERATOR_ID, photo=photo_id)
    log_dialogue.info('–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ä—Ç–∏–Ω–∫—É')


def callback_operator_left_dialog(call, bot):
    bot.delete_message(call.message.chat.id, call.message.id)
    client_id = redis_cache.get_first_client_and_delete_from_queue()
    if client_id is None:
        bot.send_message(OPERATOR_ID, f'–í—ã —É–∂–µ –≤—ã—Ö–æ–¥–∏–ª–∏ –∏–∑ —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞')
        return
    bot.delete_state(OPERATOR_ID, OPERATOR_ID)
    bot.delete_state(client_id, client_id)
    logger.info(f'–û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º: {client_id}')
    logger.info(
        f'–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ - {bot.get_state(client_id, client_id)}, –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - {bot.get_state(OPERATOR_ID, OPERATOR_ID)}')
    bot.send_message(OPERATOR_ID, f'–í—ã –≤—ã—à–ª–∏ –∏–∑ –¥–∏–∞–ª–æ–≥–∞!')
    next_client = redis_cache.get_first_client_from_queue()
    if next_client is None:
        redis_cache.set_operator_state(b'free')
        logger.info(f'–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ—Ç, —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥ –≤ "—Å–≤–æ–±–æ–¥–µ–Ω" (free)')
        return
    logger.info(f'–ó–∞–ø—Ä–æ—Å –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –Ω–∞ –¥–∏–∞–ª–æ–≥ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: {next_client}')
    logger.info(f'–ï—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ –æ—á–µ—Ä–µ–¥–∏, —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ "–∑–∞–Ω—è—Ç" (busy)')
    redis_cache.set_operator_state(b'busy')
    bot.send_message(OPERATOR_ID, f'üí¨–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–∏–∞–ª–æ–≥!üß®\n\n–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\nID: {next_client}\n'
                     , reply_markup=keyboard_for_view_customer_information(next_client))
